import streamlit as st 
import pandas as pd
from historycal_analiz import historycal_data_analizer

def run_analystic():
    st.set_page_config(
        page_title='–ê–Ω–∞–ª–∏–∑ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö',
        page_icon='üìä',
        layout='wide'
    )
    st.markdown('üìä –ê–Ω–∞–ª–∏–∑ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö')

    #–±–æ–∫–æ–≤–∞—è –ø–∞–ª–µ–Ω—å–∫–∞
    with st.sidebar:
        st.header('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–Ω–∞–ª–∏–∑–∞')
        uploaded_file = st.file_uploader('–í—ã–±–µ—Ä–∏—Ç–µ csv —Ñ–∞–π–ª ',type = ['csv'],help="–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: CSV") ###–ø–æ—Ç–æ–º—É –º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å –¥–æ json or exel
        if uploaded_file:
            st.success('–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–≥—Ä—É–∂–µ–Ω')

            #–ø—Ä–µ–≤—å—é –ø–æ—Ç–æ–º –º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å
            with st.expander('–ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä'):
                try:
                    df_preview = pd.read_csv(uploaded_file)
                    st.dataframe(df_preview.head())
                    st.write(f'–†–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö - {df_preview.shape[0]} —Å—Ç—Ä–æ–∫ –∏ {df_preview.shape[1]} –∫–æ–ª–æ–Ω–æ–∫')
                except Exception as e:
                    st.error(f'–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞ {str(e)}')

        #####–Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–Ω–∞–ª–∏–∑–∞
        st.divider()
        st.subheader('–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∞–Ω–∞–ª–∏–∑–∞')

        window_size = st.slider(
            "–†–∞–∑–º–µ—Ä –æ–∫–Ω–∞ –¥–ª—è —Å–∫–æ–ª—å–∑—è—â–µ–≥–æ —Å—Ä–µ–¥–Ω–µ–≥–æ:",
            min_value=7,
            max_value=90,
            value=30,
            help="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Å–∫–æ–ª—å–∑—è—â–µ–≥–æ —Å—Ä–µ–¥–Ω–µ–≥–æ"
        )
        anomaly_threshold = st.slider(
            "–ü–æ—Ä–æ–≥ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –∞–Ω–æ–º–∞–ª–∏–π:",
            min_value=1.0,
            max_value=3.0,
            value=2.0,
            step=0.5,
            help="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∞–Ω–æ–º–∞–ª–∏–∏"
        )
        st.divider()

        st.subheader(" –ú–µ—Ç–æ–¥ –∞–Ω–∞–ª–∏–∑–∞")
        analysts_method = st.radio(
            "–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Ç–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∞–Ω–∞–ª–∏–∑–∞:",
            ["–°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π", "–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π (Joblib)", "–ú–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω—ã–π", 
             "–ú–Ω–æ–≥–æ–ø—Ä–æ—Ü–µ—Å—Å–Ω—ã–π", "–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π", "–ó–∞–ø—É—Å—Ç–∏—Ç—å –±–µ–Ω—á–º–∞—Ä–∫ –≤—Å–µ—Ö –º–µ—Ç–æ–¥–æ–≤"],
            index=0,
            help="""–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –ø–æ–¥—Ö–æ–¥–æ–≤ –∫ –æ–±—Ä–∞–±–æ—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö:
            ‚Ä¢ –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π: –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
            ‚Ä¢ –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —è–¥–µ—Ä CPU
            ‚Ä¢ –ú–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω—ã–π: –¥–ª—è I/O –æ–ø–µ—Ä–∞—Ü–∏–π
            ‚Ä¢ –ú–Ω–æ–≥–æ–ø—Ä–æ—Ü–µ—Å—Å–Ω—ã–π: –¥–ª—è CPU-intensive –∑–∞–¥–∞—á
            ‚Ä¢ –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π: –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–¥—Ö–æ–¥–∞"""
        )
        if analysts_method  == "–ó–∞–ø—É—Å—Ç–∏—Ç—å –±–µ–Ω—á–º–∞—Ä–∫ –≤—Å–µ—Ö –º–µ—Ç–æ–¥–æ–≤":
            st.warning("‚ö†Ô∏è –ë–µ–Ω—á–º–∞—Ä–∫ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è")

        ###–Ω–∞–∫–æ–Ω–µ—Ü —Å–æ–∑–¥–∞–Ω–∏–µ –¥–∞—Ç–∞—Ñ—Ä–µ–π–º–∞
        if uploaded_file is not None:
            try:
                df = pd.read_csv(uploaded_file)

                ##–ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω—É–∂–Ω—ã—Ö –∫–æ–ª–æ–Ω–æ–∫
                required_columns = ['city', 'timestamp', 'temperature', 'season']
                missing_columns = [col for col in required_columns if col not in df.columns]
                if missing_columns:
                    st.error(f"–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∫–æ–ª–æ–Ω–∫–∏: {', '.join(missing_columns)}")
                    return
                 # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä–∞
                analyzer =  historycal_data_analizer(df)

                #–≤—ã–±–æ—Ä
                cities = df['city'].unique()
                select_city = st.selectbox('–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞:',cities)
            except Exception as e:
                st.error(f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ {str(e)}')



        



# uploaded_file = st.file_uploader('–í—ã–±–µ—Ä–∏—Ç–µ csv —Ñ–∞–π–ª ',type = ['csv'])

# if uploaded_file is not None:
#     data = pd.read_csv(uploaded_file)
#     st.write('–ø—Ä–µ–≤—å—é')
#     st.dataframe(data)
# else:
#     st.write('–≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª')

    